<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://bitcoincore.tech/apps/bitcoinjs-ui/lib/bitcoinjs-lib.js"></script>
    <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
    <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
    <title>Passenger - NostrRide</title>
  </head>
  <style>
    body {
      background-color: black;
    }

    .container {
      display: flex;
      padding: 3px;
      justify-content: space-evenly;
    }
    form {
      background-color: grey;
      color: whitesmoke;
      border-radius: 10px;
      padding: 12px;
    } 

    .ride-request {
      display: flex;
      justify-content: center;
      flex-direction: column;
      color: whitesmoke;
      margin: 3px;
    }

    .feed {
      display: flex;
      justify-content: center;
      flex-direction: column;
      color: whitesmoke;
    }

    .offer{
      background-color: grey;
      border-radius: 10px;
      margin: 12px;
      padding: 12px;
    }
  </style>
  <body>
    <div class="container">
      <div class="ride-request">
        <h1>Catch a Ride</h1>
        <form id="ride-form">
          <label for="from">From:</label>
          <input type="text" id="fromGeo" name="fromGeo" /><br /><br />

          <label for="to">To:</label>
          <input type="text" id="toGeo" name="toGeo" /><br /><br />

          <label for="price">Price:</label>
          <input type="text" id="price" name="price" /><br /><br />

          <input type="submit" value="Request a Ride!" />
          <script>
            const form = document.getElementById("ride-form");

            form.addEventListener("submit", async (event) => {
              event.preventDefault(); // prevent the default form submission behavior

              // extract form data

              const fromGeo = document.getElementById("fromGeo").value;

              const toGeo = document.getElementById("toGeo").value;

              const price = parseFloat(document.getElementById("price").value);

              // do something with the form data (e.g. send it to the server)
              var newNostrEvent = await requestRide(fromGeo, toGeo, price);
              console.log(newNostrEvent);
              relay.send(newNostrEvent);
            });
          </script>
        </form>
      </div>
      <div class="feed">
        <h2>Drivers Offering me a Ride</h2>
        <div class="event" id="events"></div>
      </div>
    </div>
    <script>
      const { getSharedSecret, schnorr, utils } = nobleSecp256k1;
      const crypto = window.crypto;
      const sha256 = bitcoinjs.crypto.sha256;
      const passenger = {
        privkey:
          "e1bed95a843145d94be5b1cb4c1d85650e410e72585b4e0510d9a981ba2b0bae",
        pubkey:
          "8b78d319a47f95d5c613a24b5d27344c87c1981f7843b57ed69f473e498a49c7",

        rating: 4,
      };

      const eventsDiv = document.getElementById("events");
     
      const relay = new WebSocket("ws://192.168.1.4:6969");

      const timestamp = Math.floor(Date.now() / 1000);

      const subId = bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" );
      const filter = {
        kinds: [14021],
        "#p": [passenger.pubkey],
        since: timestamp - 90,
      };
      relay.onopen = () => {
        relay.send(JSON.stringify(["REQ", subId, filter]));
      };

      relay.onmessage = (msg) => {
        // console.log(msg)
        var [type, subId, wsevent] = JSON.parse(msg.data.toString());
        var { kind, content, pubkey } = wsevent || {};
        // console.log(pubkey)
        if (!wsevent) return;

        if (kind == 14021) {
          console.log(content);
          // var offerData = JSON.parse(content);
          var decryptedMessage = JSON.parse(
            decrypt(passenger.privkey, pubkey, content)
          );
          console.log(decryptedMessage);
          const offerHolder = document.createElement("div");
          offerHolder.className = "offer"

          const offerDriver = document.createElement("h2");
          const offerCar = document.createElement("p");
          const offerCounter = document.createElement("p");
          const offerPay = document.createElement("p");

          const offerAccept = document.createElement("button");
          offerAccept.id = "accept-btn";
          offerAccept.className = "accept-class";
          offerAccept.innerText = "Accept this Ride!"

          offerAccept.addEventListener("click", async () => {
            // Do something when the button is clicked

            // console.log(rideData);

            var acceptOff = await acceptOffer(decryptedMessage.driver);
            console.log(acceptOff);
            relay.send(acceptOff);
          });
          offerDriver.innerText = `Driver: ${decryptedMessage.driver.substring(
            0,
            12
          )}`;
          offerCar.innerText = `${decryptedMessage.car}`;
          offerCounter.innerText = `Counter Offer: $${decryptedMessage.counter}`;
          offerPay.innerText = `Pay to Address: ${decryptedMessage.btc}`;

          if (offerHolder) {
            offerHolder.append(offerDriver);
            offerHolder.append(offerCar);
            offerHolder.append(offerCounter);
            offerHolder.append(offerPay);
            offerHolder.append(offerAccept);
          }
          if (eventsDiv){
            eventsDiv.appendChild(offerHolder)
          }
        }
      };

      async function requestRide(from, to, price) {
        var newRideRequest = {
          passengerPubkey: passenger.pubkey,
          from: from,
          to: to,
          priceOffer: price,
        };
        var message = JSON.stringify(newRideRequest);
        var event = {
          content: message,
          created_at: Math.floor(Date.now() / 1000),
          kind: 14020,
          tags: [],
          pubkey: passenger.pubkey,
        };
        var signedEvent = await getSignedEvent(event, passenger.privkey);
        var nostrEvent = JSON.stringify(["EVENT", signedEvent]);
        return nostrEvent;
      }

      async function acceptOffer(driverPubKey) {
        var message = JSON.stringify({
          passenger: passenger.pubkey,
          exactGeoTag: "lat: 12.34, 34.45",
          message: "I accept, please come pick me up!",
        });
        var encrypted = encrypt(passenger.privkey, driverPubKey, message);
        var event = {
          content: encrypted,
          created_at: Math.floor(Date.now() / 1000),
          kind: 4,
          tags: [["p", driverPubKey]],
          pubkey: passenger.pubkey,
        };
        var signedEvent = await getSignedEvent(event, passenger.privkey);
        var nostrEvent = JSON.stringify(["EVENT", signedEvent]);
        return nostrEvent;
      }

      async function getSignedEvent(event, privateKey) {
        var eventData = JSON.stringify([
          0, // Reserved for future use
          event["pubkey"], // The sender's public key
          event["created_at"], // Unix timestamp
          event["kind"], // Message “kind” or type
          event["tags"], // Tags identify replies/recipients
          event["content"], // Your note contents
        ]);
        event.id = sha256(eventData).toString("hex");
        event.sig = await schnorr.sign(event.id, privateKey);
        return event;
      }
      function hexToBytes(hex) {
        return Uint8Array.from(
          hex.match(/.{1,2}/g).map((byte) => parseInt(byte, 16))
        );
      }

      function bytesToHex(bytes) {
        return bytes.reduce(
          (str, byte) => str + byte.toString(16).padStart(2, "0"),
          ""
        );
      }
      function base64ToHex(str) {
        var raw = atob(str);
        var result = "";
        var i;
        for (i = 0; i < raw.length; i++) {
          var hex = raw.charCodeAt(i).toString(16);
          result += hex.length === 2 ? hex : "0" + hex;
        }
        return result;
      }
      function encrypt(privkey, pubkey, text) {
        var key = nobleSecp256k1
          .getSharedSecret(privkey, "02" + pubkey, true)
          .substring(2);
        var iv = window.crypto.getRandomValues(new Uint8Array(16));
        var cipher = browserifyCipher.createCipheriv(
          "aes-256-cbc",
          hexToBytes(key),
          iv
        );
        var encryptedMessage = cipher.update(text, "utf8", "base64");
        emsg = encryptedMessage + cipher.final("base64");
        var uint8View = new Uint8Array(iv.buffer);
        var decoder = new TextDecoder();
        return emsg + "?iv=" + btoa(String.fromCharCode.apply(null, uint8View));
      }
      function decrypt(privkey, pubkey, ciphertext) {
        var [emsg, iv] = ciphertext.split("?iv=");
        var key = nobleSecp256k1
          .getSharedSecret(privkey, "02" + pubkey, true)
          .substring(2);
        var decipher = browserifyCipher.createDecipheriv(
          "aes-256-cbc",
          hexToBytes(key),
          hexToBytes(base64ToHex(iv))
        );
        var decryptedMessage = decipher.update(emsg, "base64");
        dmsg = decryptedMessage + decipher.final("utf8");
        return dmsg;
      }
    </script>
  </body>
</html>
